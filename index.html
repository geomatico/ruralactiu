<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>RuralActiu</title>

		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		
  		<link rel="stylesheet" href="css/leaflet.css" />
  		<!--[if lte IE 8]><link rel="stylesheet" href="css/leaflet.ie.css" /><![endif]-->
		<link rel="stylesheet" href="cartodb-leaflet/cartodb.css" />
		<link rel="stylesheet" href="css/style.css" />
		
		<!-- script type="text/javascript" src="js/leaflet-src.js"></script-->
		<script type="text/javascript" src="js/leaflet.js"></script>
		<script type="text/javascript" src="cartodb-leaflet/wax.leaf.min-6.0.0-beta2.js"></script>
		<script type="text/javascript" src="cartodb-leaflet/cartodb-leaflet.js"></script>
		<script type="text/javascript" src="cartodb-leaflet/cartodb-infowindow.js"></script>
		<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>

		<script type="text/javascript">
			var map;
			var comarcas;
			var municipios;
			var cartodb_actividades;
			var cartodb_comarcas;
			var cartodb_municipios;
			var filtroTodasLasActividades = "SELECT * FROM {{table_name}}";
			var popup;
			
			var infoLabels = {
				nombre: 'Activitat',
				descripcion: 'Descripció',
				direccion_postal: 'Adreça Postal',
				documento: 'Documentació',
				email: 'Correu',
				fechas: 'Dates',
				plazas_libres: 'Places Lliures',
				precio: 'Preu',
				tipo_actividad: "Tipus d'activitat",
				alojamiento: 'Nom Allotjament',
				enlace_alojamiento: 'Enlaç Allotjament'
			}
			
			var infoImages = {
				"Experiencia rural": "img/rural.jpg",
				"Experiencia històrica": "img/historica.jpg",
				"Experiencia saludable": "img/saludable.jpg"
			}
			
			function init() {
				$("#toggleForm").click(function() {$("#formulario").toggle();});
				
				map = new L.Map('map');
				popup = new L.Popup();
				
				var cloudmade = new L.TileLayer('http://{s}.tile.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png', {
					attribution : 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
					maxZoom : 17
				});
				
				cartodb_comarcas = addCartoDBLayer('comarcas', "SELECT * FROM {{table_name}} where false");
				cartodb_municipios = addCartoDBLayer('municipios', "SELECT * FROM {{table_name}} WHERE false");
				
				map.addLayer(cloudmade);
				cartodb_actividades = new L.CartoDBLayer({
				    map: map,
				    user_name:"ruralactiu",
				    table_name: 'actividades',
				    query: filtroTodasLasActividades,
				    interactivity: "tipo_actividad, alojamiento, descripcion, direccion_postal, documento, email, enlace_alojamiento, fechas, nombre, plazas_libres, precio",
				    auto_bound: true,
				    debug: false,
				    featureMouseOver: function(data) {
				        document.body.style.cursor = "pointer";
				    },
				    featureMouseOut: function() {
				        document.body.style.cursor = "default";
				    },
				    featureMouseClick: function(latlng, data) {
				        // Set popup content
				        var html = '<img class="leaflet-popup-image" src="' + infoImages[data["tipo_actividad"]] + '" width="96"/>';
				        for(var column in data) {
				        	if (column == 'email') {
				        		data[column] = "<a href='mailto:" + data[column] + "'>Correu de contacte</a>";
				        	} else if (column == "documento") {
				        		data[column] = "<a href='" + data[column] + "' target='_blank'>Detalls sobre l'activitat</a>";
				        	} else if (column == "enlace_alojamiento") {
				        		data[column] = "<a href='" + data[column] + "' target='_blank'>Detalls sobre l'allotjament</a>";
				        	}
				            html += '<label class="leaflet-popup-title">' + infoLabels[column] + '</label>';
				            html += '<p class="leaflet-popup-variable">' + data[column] + '</p>';
				        }
				        popup.setContent(html);
				        popup.setLatLng(latlng);
				        map.openPopup(popup);
				    }
				});
				map.addLayer(cartodb_actividades);

				// Combo de comarcas
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT "
						+ "id, nombre, "
						+ "ST_XMin(the_geom) as xmin, ST_XMax (the_geom) as xmax,ST_YMin (the_geom) as ymin,ST_YMax (the_geom) as ymax "
						+ "FROM comarcas order by nombre",
					dataType:"json"}).done(function ( data ) {
					comarcas = new Object();
					$('#cmbComarcas').append($('<option>(comarca)</option>').val(-1));
					for (i in data.rows) {
						var row = data.rows[i];
						comarcas[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
						$('#cmbComarcas').append($('<option>'+row.nombre+'</option>').val(row.id));
					}
				});
				
				// Combo de tipos de actividad
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT distinct(tipo_actividad) FROM actividades order by tipo_actividad",dataType:"json"}).done(function ( data ) {
					for (i in data.rows) {
						var row = data.rows[i];
						$('#cmbTipoActividad').append($('<option>'+row.tipo_actividad+'</option>').val(row.tipo_actividad));
					}
				});
				
				// Eventos
				$('#cmbComarcas').change(function() {
					comarcaCode = $('#cmbComarcas').val();
					if (comarcaCode != -1) {
						var bbox = comarcas[comarcaCode];
						cartodb_comarcas.setQuery("SELECT * FROM {{table_name}} where id='" + comarcaCode + "'");
						cartodb_municipios.setQuery("SELECT * FROM {{table_name}} where id_comarca='" + comarcaCode + "'");
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
						console.log(map._layers);
					}

					// Rellena municipios
					$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT id,nombre ,ST_XMin (the_geom) as xmin,ST_XMax (the_geom) as xmax,ST_YMin (the_geom) as ymin,ST_YMax (the_geom) as ymax FROM municipios where id_comarca='" + comarcaCode + "' order by nombre",dataType:"json"}).done(function (data) {
						$('#cmbMunicipios').children().remove();
						$('#cmbMunicipios').append($('<option>(municipi)</option>').val(-1));
						municipios = {};
						for (i in data.rows) {
							var row = data.rows[i];
							municipios[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
							$('#cmbMunicipios').append($('<option>'+row.nombre+'</option>').val(row.id));
						}
					});
				});
				
				$('#cmbMunicipios').change(function() {
					municipioCode = $('#cmbMunicipios').val();
					if (municipioCode != -1) {
						var bbox = municipios[municipioCode];
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
					}
				});
				
				$('#cmbTipoActividad').change(function() {
					tipoActividad = $('#cmbTipoActividad').val();
					if (tipoActividad != -1) {
						updateCartoDBActividades("SELECT * FROM {{table_name}} WHERE tipo_actividad='" + tipoActividad + "'",
								"tipo_actividad='" + tipoActividad + "'");
					}
				});
				
				$('#btnBusqueda').click(function() {
					updateCartoDBActividades("SELECT * FROM {{table_name}} where "
							+ "lower(descripcion) like '%"	+ $('#txtBusqueda').val() + "%' "
							+ "or lower(nombre) like '%" + $('#txtBusqueda').val() + "%'",
							"lower(descripcion) like '%25"	+ $('#txtBusqueda').val() + "%25' "
							+ "or lower(nombre) like '%25" + $('#txtBusqueda').val() + "%25'");
				});
				
				$('#btnTodos').click(function() {
					updateCartoDBActividades(filtroTodasLasActividades, "true");
				});
			}
			
			function addCartoDBLayer(tablename, query) {
				var cartoDBLayer = new L.CartoDBLayer({
					map: map,
					user_name:"ruralactiu",
					table_name: tablename,
					query: query,
					auto_bound: true,
					debug: false
				});
				map.addLayer(cartoDBLayer);
				return cartoDBLayer;
			}

			function updateCartoDBActividades(layerQuery, extentWhere) {
				cartodb_actividades.setQuery(layerQuery);
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT "
						+ "ST_XMin (ST_Extent(the_geom)) as xmin,"
						+ "ST_XMax (ST_Extent(the_geom)) as xmax,"
						+ "ST_YMin (ST_Extent(the_geom)) as ymin,"
						+ "ST_YMax (ST_Extent(the_geom)) as ymax "
							+ "FROM actividades WHERE " + extentWhere, dataType:"json"}).done(function(data) {
					if (data.rows.length > 0) {
						var row = data.rows[0];
						var sw = new L.LatLng(row.ymin, row.xmin);
						var ne = new L.LatLng(row.ymax, row.xmax);
						
						// Check minimum bounds size
						var width = row.xmax - row.xmin;
						var minSize = 0.05;
						if (width < minSize) {
							ne.lng = ne.lng + minSize/2;
							sw.lng = sw.lng - minSize/2;
						}
						var height = row.ymax - row.ymin;
						if (height < minSize) {
							ne.lat = ne.lat + minSize/2;
							sw.lat = sw.lat - minSize/2;
						}						
						map.fitBounds(new L.LatLngBounds(sw, ne));
					}
				});
			}
		</script>
	</head>
	<body onload="init()">
		<div class="borde" id="toggleBorde">
			<div id="toggleForm"></div>
		</div>
		<div class="borde" id="formulario">
			<h4>Cerca activitats</h4>
			<div>
				<select id="cmbComarcas"></select>
			</div>
			<div>
				<select id="cmbMunicipios"><option value="-1">(municipi)</option></select>
			</div>
			<div>
				<select id="cmbTipoActividad"><option value="-1">(tipus)</option></select>
			</div>
			<div>
				<input id="txtBusqueda" type="text"></input>
				<input id="btnBusqueda" type="submit" value="Cerca"></input>
			</div>
			<div>
				<input id="btnTodos" type="submit" value="Mostra totes"></input>
			</div>
		</div>
		<div id="map"></div>
	</body>
</html>
