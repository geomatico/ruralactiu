<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>RuralActiu</title>
		<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css" />
		<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css" />
		<link rel="stylesheet" href="css/ui-darkness/jquery-ui-1.8.19.custom.css" />
		<link rel="stylesheet" href="css/ui-darkness/jquery.ui.selectmenu.css" />
		<link rel="stylesheet" href="css/style.css" />
		
		<script src="http://code.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>
		<script type="text/javascript" src="js/wax.leaflet.min.js"></script>
		<script type="text/javascript" src="js/cartodb-leaflet.js"></script>
		<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.19.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.ui.selectmenu.js"></script>

		<script type="text/javascript">
			var map;
			var comarcas;
			var municipios;
			var cartodb_actividades;
			var cartodb_comarcas;
			var cartodb_municipios;
			var filtroTodasLasActividades = "SELECT * FROM {{table_name}}";

			function init() {
				map = new L.Map('map');

				var cloudmade = new L.TileLayer('http://{s}.tile.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png', {
					attribution : 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
					maxZoom : 17
				});
				
				// geographical point (longitude and latitude)
				map.addLayer(cloudmade);
				cartodb_actividades = new L.CartoDBLayer({
				          map_canvas: 'map_canvas',
				          map: map,
				          user_name:"ruralactiu",
				          table_name: 'actividades',
				          query: filtroTodasLasActividades,
				          infowindow: "SELECT * FROM {{table_name}} WHERE cartodb_id={{feature}}",
				          auto_bound: false,
				          debug: true
				        });
				map.addLayer(cartodb_actividades);
				cartodb_comarcas = new L.CartoDBLayer({
					  map_canvas: 'map_canvas',
					  map: map,
					  user_name:"ruralactiu",
					  table_name: 'comarcas',
					  query: "SELECT * FROM {{table_name}} where false",
					  //infowindow: "SELECT * FROM {{table_name}} WHERE cartodb_id={{feature}}",
					  auto_bound: false,
					  debug: true
					});
				map.addLayer(cartodb_comarcas);
				cartodb_municipios = new L.CartoDBLayer({
					  map_canvas: 'map_canvas',
					  map: map,
					  user_name:"ruralactiu",
					  table_name: 'municipios',
					  query: "SELECT * FROM {{table_name}} WHERE false",
					  //infowindow: "SELECT * FROM {{table_name}} WHERE cartodb_id={{feature}}",
					  auto_bound: false,
					  debug: true
					});
				map.addLayer(cartodb_municipios);
				
				// Zoom a actividades
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT "
						+ "ST_XMin (ST_Extent(the_geom)) as xmin,"
						+ "ST_XMax (ST_Extent(the_geom)) as xmax,"
						+ "ST_YMin (ST_Extent(the_geom)) as ymin,"
						+ "ST_YMax (ST_Extent(the_geom)) as ymax "
						+ "FROM actividades",
						dataType:"json"}).done(function ( data ) {
					var bbox = data.rows[0];
					map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
				});

				// Combo de comarcas
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT "
						+ "id, nombre, "
						+ "ST_XMin(the_geom) as xmin, ST_XMax (the_geom) as xmax,ST_YMin (the_geom) as ymin,ST_YMax (the_geom) as ymax "
						+ "FROM comarcas order by nombre",
					dataType:"json"}).done(function ( data ) {
					comarcas = new Object();
					$('#cmbComarcas').append($('<option>(escolliu una comarca)</option>').val(-1));
					for (i in data.rows) {
						var row = data.rows[i];
						comarcas[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
						$('#cmbComarcas').append($('<option>'+row.nombre+'</option>').val(row.id));
					}
					$('#cmbComarcas').selectmenu();
				});
				// Combo de tipos de actividad
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT distinct(tipo_actividad) FROM actividades order by tipo_actividad",dataType:"json"}).done(function ( data ) {
					for (i in data.rows) {
						var row = data.rows[i];
						$('#cmbTipoActividad').append($('<option>'+row.tipo_actividad+'</option>').val(row.tipo_actividad));
					}
					$('#cmbTipoActividad').selectmenu();
				});
				
				// Eventos
				$('#cmbComarcas').change(function() {
					comarcaCode = $('#cmbComarcas').val();
					if (comarcaCode != -1) {
						var bbox = comarcas[comarcaCode];
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
						cartodb_comarcas.update({query:"SELECT * FROM {{table_name}} where id='" + comarcaCode + "'"});
						cartodb_municipios.update({query:"SELECT * FROM {{table_name}} where id_comarca='" + comarcaCode + "'"});
					}

					// Rellena municipios
					$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT id,nombre ,ST_XMin (the_geom) as xmin,ST_XMax (the_geom) as xmax,ST_YMin (the_geom) as ymin,ST_YMax (the_geom) as ymax FROM municipios where id_comarca='" + comarcaCode + "' order by nombre",dataType:"json"}).done(function ( data ) {
						municipios = new Object();
						$('#cmbMunicipios').children().remove();
						$('#cmbMunicipios').append($('<option>(escolliu un municipi)</option>').val(-1));
						for (i in data.rows) {
							var row = data.rows[i];
							municipios[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
							$('#cmbMunicipios').append($('<option>'+row.nombre+'</option>').val(row.id));
						}
						$('#cmbMunicipios').selectmenu();
					});
				});
				$('#cmbMunicipios').change(function() {
					municipioCode = $('#cmbMunicipios').val();
					if (municipioCode != -1) {
						var bbox = municipios[municipioCode];
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
					}
				});
				$('#cmbTipoActividad').change(function() {
					tipoActividad = $('#cmbTipoActividad').val();
					if (tipoActividad != -1) {
						updateCartoDBActividades("SELECT * FROM {{table_name}} WHERE tipo_actividad='" + tipoActividad + "'",
								"tipo_actividad='" + tipoActividad + "'");
					}
				});
				$('#btnBusqueda').click(function() {
					updateCartoDBActividades("SELECT * FROM {{table_name}} where "
							+ "lower(descripcion) like '%"	+ $('#txtBusqueda').val() + "%' "
							+ "or lower(nombre) like '%" + $('#txtBusqueda').val() + "%'",
							"lower(descripcion) like '%25"	+ $('#txtBusqueda').val() + "%25' "
							+ "or lower(nombre) like '%25" + $('#txtBusqueda').val() + "%25'");
				});
				$('#btnTodos').click(function() {
					updateCartoDBActividades(filtroTodasLasActividades, "true");
				});
				
				$("input:submit").button();
				$('select').selectmenu();
			}

			function updateCartoDBActividades(layerQuery, extentWhere) {
				cartodb_actividades.update({query:layerQuery});
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT "
						+ "ST_XMin (ST_Extent(the_geom)) as xmin,"
						+ "ST_XMax (ST_Extent(the_geom)) as xmax,"
						+ "ST_YMin (ST_Extent(the_geom)) as ymin,"
						+ "ST_YMax (ST_Extent(the_geom)) as ymax "
							+ "FROM actividades WHERE " + extentWhere, dataType:"json"}).done(function ( data ) {
					if (data.rows.length > 0) {
						var row = data.rows[0];
						var sw = new L.LatLng(row.ymin, row.xmin);
						var ne = new L.LatLng(row.ymax, row.xmax);
						
						// Check minimum bounds size
						var width = row.xmax - row.xmin;
						var minSize = 0.05;
						if (width < minSize) {
							ne.lng = ne.lng + minSize/2;
							sw.lng = sw.lng - minSize/2;
						}
						var height = row.ymax - row.ymin;
						if (height < minSize) {
							ne.lat = ne.lat + minSize/2;
							sw.lat = sw.lat - minSize/2;
						}
						
						console.log(sw);
						console.log(ne);
						
						map.fitBounds(new L.LatLngBounds(sw, ne));
					}
				});
				
			}
		</script>
	</head>
	<body onload="init()">
		<div id="map"></div>
		<div class="formulario">
			<select id="cmbComarcas">
			</select>
			<select id="cmbMunicipios">
				<option value="-1">(escolliu un municipi)</option>
			</select>
			<br/>
			<select id="cmbTipoActividad">
				<option value="-1">(escolliu una activitat)</option>
			</select>
			<span class="ui-widget"><input id="txtBusqueda" type="text" class="ui-widget-content"></input></span>
			<input id="btnBusqueda" type="submit" value="Cerca"></input>
			<br/>
			<input id="btnTodos" type="submit" value="Mostra totes les activitats"></input>
		</div>

	</body>
</html>
