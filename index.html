<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>RuralAcitu</title>
		<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css" />
		<script src="http://code.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>

		<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css" />
		<script type="text/javascript" src="js/wax.leaflet.min.js"></script>
		<script type="text/javascript" src="js/cartodb-leaflet.js"></script>
		<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.19.custom.min.js"></script>

		<script type="text/javascript">
			var map;
			var comarcas;
			var municipios;
			var cartodb_actividades;
			var filtroTodasLasActividades = "SELECT * FROM {{table_name}}";

			function init() {
				map = new L.Map('map', {
					center: new L.LatLng(42.211279, 2.195804), 
					zoom: 10
				});

				var cloudmade = new L.TileLayer('http://{s}.tile.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png', {
					attribution : 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
					maxZoom : 17
				});
				
				// geographical point (longitude and latitude)
				map.addLayer(cloudmade);
				cartodb_actividades = newCartoDB(filtroTodasLasActividades);
				map.addLayer(cartodb_actividades);

				// Combo de comarcas
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT id,nombre ,ST_XMin(the_geom) as xmin,ST_XMax (the_geom) as xmax,ST_YMin (the_geom) as ymin,ST_YMax (the_geom) as ymax FROM comarcas order by nombre"}).done(function ( data ) {
					comarcas = new Object();
					$('#cmbComarcas').append($('<option>Elija una comarca</option>').val(-1));
					for (i in data.rows) {
						var row = data.rows[i];
						comarcas[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
						$('#cmbComarcas').append($('<option>'+row.nombre+'</option>').val(row.id));
					}
				});
				// Combo de tipos de actividad
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT distinct(tipo_actividad) FROM actividades order by tipo_actividad"}).done(function ( data ) {
					for (i in data.rows) {
						var row = data.rows[i];
						$('#cmbTipoActividad').append($('<option>'+row.tipo_actividad+'</option>').val(row.tipo_actividad));
					}
				});
				
				// Eventos
				$('#cmbComarcas').change(function() {
					comarcaCode = $('#cmbComarcas').val();
					if (comarcaCode != -1) {
						var bbox = comarcas[comarcaCode];
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
					}

					// Rellena municipios
					$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT id,nombre ,ST_XMin (the_geom) as xmin,ST_XMax (the_geom) as xmax,ST_YMin (the_geom) as ymin,ST_YMax (the_geom) as ymax FROM municipios where id_comarca='" + comarcaCode + "' order by nombre"}).done(function ( data ) {
						municipios = new Object();
						$('#cmbMunicipios').children().remove();
						$('#cmbMunicipios').append($('<option>Elija un municipio</option>').val(-1));
						for (i in data.rows) {
							var row = data.rows[i];
							municipios[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
							$('#cmbMunicipios').append($('<option>'+row.nombre+'</option>').val(row.id));
						}
					});
				});
				$('#cmbMunicipios').change(function() {
					municipioCode = $('#cmbMunicipios').val();
					if (municipioCode != -1) {
						var bbox = municipios[municipioCode];
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
					}
				});
				$('#cmbTipoActividad').change(function() {
					tipoActividad = $('#cmbTipoActividad').val();
					if (tipoActividad != -1) {
						map.removeLayer(cartodb_actividades);
						cartodb_actividades = newCartoDB("SELECT * FROM {{table_name}} where tipo_actividad='" + tipoActividad + "'");
						map.addLayer(cartodb_actividades);
					}
				});
				$('#btnBusqueda').click(function() {
					map.removeLayer(cartodb_actividades);
					cartodb_actividades = newCartoDB("SELECT * FROM {{table_name}} where descripcion like '%" + $('#txtBusqueda').val() + "%' or nombre like '%" + $('#txtBusqueda').val() + "%'");
					map.addLayer(cartodb_actividades);
				});
				$('#btnTodos').click(function() {
					map.removeLayer(cartodb_actividades);
					cartodb_actividades = newCartoDB(filtroTodasLasActividades);
					map.addLayer(cartodb_actividades);
				});
			}

			function newCartoDB(query) {
				return new L.CartoDBLayer({
				  map_canvas: 'map_canvas',
				  map: map,
				  user_name:"ruralactiu",
				  table_name: 'actividades',
				  query: query,
				  infowindow: "SELECT nombre,descripcion,tipo_actividad FROM {{table_name}} WHERE cartodb_id={{feature}}",
				  auto_bound: false,
				  debug: true
				});
			}
		</script>
	</head>
	<body onload="init()">
		<div id="map" style="height: 600px; width: 600px"></div>
		<select id="cmbComarcas">
		</select>
		<select id="cmbMunicipios">
			<option value="-1">Elija primero una comarca</option>
		</select>
		<select id="cmbTipoActividad">
			<option value="-1">Seleccione una actividad</option>
		</select>
		<input id="txtBusqueda" type="text"></input>
		<input id="btnBusqueda" type="submit" value="Buscar"></input>
		<input id="btnTodos" type="submit" value="Mostrar todos"></input>
	</body>
</html>
