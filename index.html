<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>RuralAcitu</title>
		<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css" />
		<script src="http://code.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>

		<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css" />
		<script type="text/javascript" src="js/wax.leaflet.min.js"></script>
		<script type="text/javascript" src="js/cartodb-leaflet.js"></script>
		<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.19.custom.min.js"></script>

		<script type="text/javascript">
			var map;
			var comarcas;
			
			function init() {
				map = new L.Map('map', {
					center: new L.LatLng(42.211279, 2.195804), 
					zoom: 10
				});

				var cloudmade = new L.TileLayer('http://{s}.tile.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png', {
					attribution : 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
					maxZoom : 17
				});
				
				// geographical point (longitude and latitude)
				map.addLayer(cloudmade);

				var cartodb_actividades = new L.CartoDBLayer({
				  map_canvas: 'map_canvas',
				  map: map,
				  user_name:"ruralactiu",
				  table_name: 'actividades',
				  query: "SELECT * FROM {{table_name}}",
				  tile_style: "#{{table_name}}{marker-fill:#E25B5B}",
				  infowindow: "SELECT name,description,tipo_actividad FROM {{table_name}} WHERE cartodb_id={{feature}}",
				  auto_bound: false,
				  debug: true
				});

				// Carga comarcas
				$.ajax({url: "http://ruralactiu.cartodb.com/api/v2/sql?q=SELECT%20id,nombre%20,ST_XMin%28the_geom%29%20as%20xmin,ST_XMax%28the_geom%29%20as%20xmax,ST_YMin%28the_geom%29%20as%20ymin,ST_YMax%28the_geom%29%20as%20ymax%20FROM%20comarcas order by nombre"}).done(function ( data ) {
					comarcas = new Object();
					$('#cmbComarcas').append($('<option>Elija una comarca</option>').val(-1));
					for (i in data.rows) {
						var row = data.rows[i];
						comarcas[row.id] = {'xmin':row.xmin, 'ymin':row.ymin, 'xmax':row.xmax, 'ymax':row.ymax};
						$('#cmbComarcas').append($('<option>'+row.nombre+'</option>').val(row.id));
					}
					console.log(comarcas);
				});
				$('#cmbComarcas').change(function() {
					comarcaCode = $('#cmbComarcas').val();
					if (comarcaCode != -1) {
						var bbox = comarcas[comarcaCode];
						map.fitBounds(new L.LatLngBounds(new L.LatLng(bbox.ymin, bbox.xmin), new L.LatLng(bbox.ymax, bbox.xmax)));
					}
				});
				/*
				* Da "onadd is not a function" y no se ejecuta nada después
				*/
				map.addLayer(cartodb_actividades);
			}

		</script>
	</head>
	<body onload="init()">
		<div id="map" style="height: 600px; width: 600px"></div>
		<select id="cmbComarcas">
		</select>
	</body>
</html>
